#class {mipchatlog} {open}

#NOP -- Discord Message Sending;
#NOP -- Update the below with the webhook URL for each particular discord channel;
#NOP -- Set these variables in the user/player variables;
#NOP -- #var webhook[url][general] https://discord.com/api/webhooks/long_token;
#NOP -- #var webhook[url][tells] https://discord.com/api/webhooks/long_token;
#NOP -- #var webhook[url][clan] https://discord.com/api/webhooks/long_token;
#NOP -- #var webhook[url][guild] https://discord.com/api/webhooks/long_token;
#NOP -- #var webhook[url][high_mortal] https://discord.com/api/webhooks/long_token;
#NOP -- #var webhook[url][party] https://discord.com/api/webhooks/long_token;


#NOP -- Variables for the chat categories;
#var chatCategory general;
#var chat[general] {};
#var chat[tells] {};
#var chat[clan] {};
#var chat[guild] {};
#var chat[high_mortal] {};
#var chat[party] {};


#alias postChatCategory {
	#var chat[${chatCategory}] ${discordText};
	#if {&chat[${chatCategory}][] >= $chat[max]} {
		#list chat[${chatCategory}] del 1;
	};
	#list chat[${chatCategory}] ins -1 ${discordText};
	#math chat[unread][${chatCategory}] {$chat[unread][${chatCategory}] + 1};
};

#alias postDiscord {
	#NOP -- first paramater is webook destination, second is payload;
	#var payload @sanitizePayload{%0};

	#NOP -- Update scripts/discordPost.py to where the python file is located, this depends on the root that;
	#NOP -- tintin is being called from;	
	#script {python3 scripts/discordPost.py $webhook[url][general] $payload};
	#if {"$discordChannel" != "$webhook[url][general]"} {
		#script {python3 scripts/discordPost.py $discordChannel $payload};
	};
};


#VAR ignoreEmotes {small %* sighs;pauses for a moment;finishes his performance with a bow.;cracks his knuckles and gets ready to play for;performs a rather incomprehensible action on the corpse.;wounds close rapidly.;whinnies as;rubs its head on;face as he pats him on the neck.;That hurt!;cries 'OW;takes a deep breath;takes a breath;ceases his performance;briefly closes his eyes;wraps his arms around;bows and bids you;reaches into a small pouch and draws forth a small pearl, black as the darkest night.; appears slightly drained.; spirit of the beast leaves your body, slightly weakening you.;is afk:;malicious attacks fade.;fills his glass with water from his pitcher.;drinks from his glass of water.;fills her glass with water from her pitcher.;drinks from her glass of water.;grovels shamelessly;collects %* coins, then hands you %*.;shell of energy flickers slighty around %*};
#VAR ignoreMisc {Gen-Notify;All gold divvied;GOLD divvy called by;Path to find me is:};

#NOP -- Get system user name to log to;
#script {sysUser} {whoami};#var sysUser $sysUser[1];

#function sanitizePayload {
	#NOP -- Function to remove potentially problematic characters from the payload;
	#NOP -- Maybe we can replace these with char or ascii representations to pass the desired character;
	#var tempString {%0};
	#replace tempString {#} {};
	#replace tempString {$} {};
	#replace tempString {*} {};
	#replace tempString {;} {};
	#replace tempString {"} {};
	#replace tempString {`} {};
	#replace tempString {'} {};
	#replace tempString {"} {};
	#replace tempString {\} {};
	#replace tempString {/} {};
	#replace tempString {(} {[};
	#replace tempString {)} {]};
	#replace tempString {-} {_};
	#replace tempString {<} {[};
	#replace tempString {>} {]};
	#replace tempString {&} { and };
	#replace tempString {|} { or };
    #line strip #var {_santized_payload} {$tempString};
    #return $_santized_payload;
};

#function ansiStrip {
    #line strip #var tempString {%0};
    #replace {tempString} {\;} {};
    #return {$tempString};
};

#alias filterSpam {
	#foreach $ignoreMisc {item} {#list chat[general] filter {} {%*${item}%*};#list chat[tell] filter {} {%*${item}%*};};
	#foreach $ignoreEmotes {item} {#list chat[general] filter {} {%*${item}%*};#list chat[tell] filter {} {%*${item}%*};};
};

#NOP ***** Broadcast Communication (Chat/Shout) *****;
#ALIAS {.mipProcessCAAgag} {
	#var mipgag 0;

	#NOP Party Divvy gag;
        #REGEX {%0} {[PARTY] GOLD divvy called by } {#var mipgag 1};
        #REGEX {%0} {[PARTY] All gold divvied, total: } {#var mipgag 1};

	#NOP Gentech Notify Line;
		#REGEX {%0} {gnotify~Notify~%*~[Gen-Nofity]: } {#var mipgag 1};

	#IF {$mipgag == 0} {.mipProcessCAA %0}
};

#alias {.handleCommLine} {
	#var tmpCommLine %0;
	#var tmpCommGuild 0;
	#var tmpCommClan 0;
	#var tmpCommParty 0;
	#var tmpCommHM 0;
	#switch {"$tmpCommLine"} {
		#NOP -- Some of these might be guild lines, if they are update to the guild below;
		#case {"Auction"}      	  	{#var {commcol} {${theme[chatcolor][auction]}}};
		#case {"Announce"}  	  	{#var {commcol} {<168>}};
		#case {"BS Announce"}  	  	{#var {commcol} {<168>}};
		#case {"BS Tell"}      	  	{#var {commcol} {<128>}};
		#case {"C-Trade"}	   	  	{#var {commcol} {<178>}};
		#case {"Clan %*"}      	  	{#var {commcol} {<158>};#var tmpCommClan 1;};
		#case {"Com"}          	  	{#var {commcol} {<128>}};
		#case {"Council"}      	  	{#var {commcol} {<108>}};
		#case {"Craft"}	   	  		{#var {commcol} {<178>}};
		#case {"Cult Game"}	   	  	{#var {commcol} {<ace>}};
		#case {"Events"}       	  	{#var {commcol} {<168>}};
		#case {"Explorer"}     	  	{#var {commcol} {<178>}};
		#case {"Fcom"}         	  	{#var {commcol} {<268>}};
		#case {"Gamers"}       	  	{#var {commcol} {<268>}};
		#case {"High Mortal"}  	  	{#var {commcol} {${theme[chatcolor][hm]}};#var tmpCommHM 1;};
		#case {"House Chat"}		{#var {commcol} {<268>}};
		#case {"Lottery"}         	{#var {commcol} {<178>}};
		#case {"Main"}              {#var {commcol} {<118>}};
		#case {"Ncom"}              {#var {commcol} {<268>}};
		#case {"Newbie"}            {#var {commcol} {<138>}};
		#case {"Notify"}            {#var {commcol} {<168>}};
		#case {"Party"}             {#var {commcol} {${theme[chatcolor][party]}};#var tmpCommParty 1};
		#case {"Poll"}              {#var {commcol} {<178>}};
		#case {"Professions"}       {#var {commcol} {<178>}};
		#case {"Shout"}             {#var {commcol} {<178>}};
		#case {"Sports Football"}   {#var {commcol} {<178>}};
		#case {"Slime Chat"}        {#var {commcol} {<128>}};
		#case {"Zilch_shout"}       {#var {commcol} {<168>}};

		#NOP -- Guild Lines;

		#NOP -- Multiple guilds use these flags or have access to these lines;
		#case {"RG Admin"}        {#var {commcol} {<168>};#var tmpCommGuild 1};
		

		#NOP -- Angel;
		#case {"Angel"}            	{#var {commcol} {<168>};#var tmpCommGuild 1};

		#NOP -- Bard;
		#case {"ADMIN"}            	{#var {commcol} {<158>};#var tmpCommGuild 1};
		#case {"Bard 30"}			{#var {commcol} {<ddd>};#var tmpCommGuild 1};
		#case {"Bard 50"}			{#var {commcol} {<ddd>};#var tmpCommGuild 1};
		#case {"Bard 70"}			{#var {commcol} {<ddd>};#var tmpCommGuild 1};
		#case {"Bard Admin"}		{#var {commcol} {<ddd>};#var tmpCommGuild 1};
		#case {"Bard Elder"}		{#var {commcol} {<ddd>};#var tmpCommGuild 1};
		#case {"Bard Gallant"}		{#var {commcol} {<ddd>};#var tmpCommGuild 1};
		#case {"Bard Leader"}		{#var {commcol} {<ddd>};#var tmpCommGuild 1};
		#case {"Bard Main"}			{#var {commcol} {<118>};#var tmpCommGuild 1};
		#case {"Bard Mystic"}		{#var {commcol} {<ddd>};#var tmpCommGuild 1};

		#NOP -- Breed;
		#case {"Breed"}             {#var {commcol} {<158>};#var tmpCommGuild 1};
		#case {"BreedOOC"}          {#var {commcol} {<258>};#var tmpCommGuild 1};
		
		#NOP -- Cyborg;
		#case {"Cyborg Com"}        {#var {commcol} {<138>};#var tmpCommGuild 1};
		#case {"Cyborg Death"}      {#var {commcol} {<218>};#var tmpCommGuild 1};
		#case {"Cyborg Guild"}      {#var {commcol} {<228>};#var tmpCommGuild 1};
		#case {"Cyborg Notify"}     {#var {commcol} {<268>};#var tmpCommGuild 1};
		#case {"Cyborg Syndicate"}  {#var {commcol} {<128>};#var tmpCommGuild 1};

		#NOP -- Elemental;
		#case {"EL-75"} 			{#var {commcol} {<178>};#var tmpCommGuild 1};
		#case {"Main"} 				{#var {commcol} {<118>};#var tmpCommGuild 1};
		#case {"Megamental"} 		{#var {commcol} {<178>};#var tmpCommGuild 1};
		#case {"Mental Adept"}		{#var {commcol} {<178>};#var tmpCommGuild 1};
		#case {"Mental Master"} 	{#var {commcol} {<178>};#var tmpCommGuild 1};
		#case {"S100"} 				{#var {commcol} {<178>};#var tmpCommGuild 1};
		#case {"Spirit"} 			{#var {commcol} {<178>};#var tmpCommGuild 1};
		#case {"Time"}            	{#var {commcol} {<168>};#var tmpCommGuild 1};

		#NOP -- Eternal;
		#case {"Eternal Main"}      {#var {commcol} {<168>};#var tmpCommGuild 1};

		#NOP Fremen;
		#case {"Fremen Tp"}    		{#var {commcol} {<128>};#var tmpCommGuild 1};
		#case {"Fremen Guild"}    	{#NOP -- block so guild skill training etc doesnt spam;};
		#case {"Fremen Ntp"}    	{#var {commcol} {<128>};#var tmpCommGuild 1};
		#case {"Fremen Rtp"}    	{#var {commcol} {<128>};#var tmpCommGuild 1};

		#NOP Gentech;
		#case {"Alpha"}            	{#var {commcol} {<168>};#var tmpCommGuild 1};
		#case {"Beta"}            	{#var {commcol} {<168>};#var tmpCommGuild 1};
		#case {"Defense"}          	{#var {commcol} {<168>};#var tmpCommGuild 1};
		#case {"Ggent"}          	{#var {commcol} {<168>};#var tmpCommGuild 1};
		#case {"Gamma"}          	{#var {commcol} {<168>};#var tmpCommGuild 1};
		#case {"Offense"}          	{#var {commcol} {<168>};#var tmpCommGuild 1};
		#case {"Notify"}          	{#NOP -- block so echelon etc doesnt spam;};
		#case {"Sci"}          		{#var {commcol} {<168>};#var tmpCommGuild 1};


		#NOP -- Jedi;
		#case {"Jedi"}              {#var {commcol} {<158>};#var tmpCommGuild 1};
		#case {"JEDI"}              {#var {commcol} {<128>};#var tmpCommGuild 1};
		
		#NOP -- Juggernaut;
		#case {"Bear"}              {#var {commcol} {<168>};#var tmpCommGuild 1};
		#case {"Bloodname"}         {#var {commcol} {<218>};#var tmpCommGuild 1};
		#case {"Falcon"}            {#var {commcol} {<128>};#var tmpCommGuild 1};
		#case {"Gjugg"}             {#var {commcol} {${theme[chatcolor][gjugg]}};#var tmpCommGuild 1};
		#case {"JuggAnnounce"}      {#var {commcol} {<118>};#var tmpCommGuild 1};
		#case {"JuggMissiles"}      {#var {commcol} {<118>};#var tmpCommGuild 1};
		#case {"JuggNewbie"}        {#var {commcol} {<258>};#var tmpCommGuild 1};
		#case {"Loremaster"}        {#var {commcol} {<274>};#var tmpCommGuild 1};
		#case {"Whine"}             {#var {commcol} {<118>};#var tmpCommGuild 1};
		#case {"Wolf"}            	{#var {commcol} {<228>};#var tmpCommGuild 1};

		#NOP -- Knights;
		#case {"Knight Announce"}   {#var {commcol} {<168>};#var tmpCommGuild 1};
		#case {"Knight Main"}       {#var {commcol} {<168>};#var tmpCommGuild 1};
		
		#NOP Mages;
		#case {"Mage"}		    	{#var {commcol} {<118>};#var tmpCommGuild 1};
		#case {"Arch Mage"}		    {#var {commcol} {<118>};#var tmpCommGuild 1};
		#case {"Black Pearl"}		{#var {commcol} {<118>};#var tmpCommGuild 1};
		#case {"Crimson Rose"}		{#var {commcol} {<118>};#var tmpCommGuild 1};
		#case {"Flaming Palm"}		{#var {commcol} {<118>};#var tmpCommGuild 1};
		#case {"Gmage"}		    	{#var {commcol} {<118>};#var tmpCommGuild 1};
		#case {"High Mage"}		    {#var {commcol} {<118>};#var tmpCommGuild 1};
		#case {"Platinum Star"}		{#var {commcol} {<118>};#var tmpCommGuild 1};
		#case {"Sorcerer"}		    {#var {commcol} {<118>};#var tmpCommGuild 1};
		#case {"Tyrian Vines"}		{#var {commcol} {<118>};#var tmpCommGuild 1};
		#case {"Visionary"}		    {#var {commcol} {<118>};#var tmpCommGuild 1};


		#NOP -- Monk;
		#case {"Monk"}            	{#var {commcol} {<238>};#var tmpCommGuild 1};

		#NOP -- Necromancer;
		#case {"Lich"}            	{#var {commcol} {<158>};#var tmpCommGuild 1};
		#case {"Gnecr"}            	{#var {commcol} {<158>};#var tmpCommGuild 1};
		#case {"Necro"}            	{#var {commcol} {<158>};#var tmpCommGuild 1};
		#case {"Sphere-%*"}      	{#var {commcol} {<158>};#var tmpCommGuild 1};
		#case {"Were"}            	{#var {commcol} {<158>};#var tmpCommGuild 1};

		#NOP -- Priest;
		#case {"Bitch"}        		{#var {commcol} {<168>};#var tmpCommGuild 1};
		#case {"Embodiment"}      	{#var {commcol} {<158>};#var tmpCommGuild 1};
		#case {"Gprie"}      	    {#var {commcol} {<158>};#var tmpCommGuild 1};
		#case {"Light Path"}      	{#var {commcol} {<158>};#var tmpCommGuild 1};
		#case {"Priest"}      	    {#var {commcol} {<158>};#var tmpCommGuild 1};
		#case {"Priest Announce"}   {#NOP -- block this line from logging;};
		#case {"Priest Broadcast"}  {#NOP -- block this line from logging;};
		
		#NOP -- Psicorps;
		#case {"Psi Main"}        	{#var {commcol} {<168>};#var tmpCommGuild 1};

		#NOP -- Sii;
		#case {"Gsii"}        		{#var {commcol} {<168>};#var tmpCommGuild 1};
		#case {"HiPsi"}        		{#var {commcol} {<168>};#var tmpCommGuild 1};
		#case {"Psi"}        		{#var {commcol} {<168>};#var tmpCommGuild 1};



		#default		        	{#var {commcol} {<178>}};
	};

	#if {$tmpCommHM} {
		#var discordChannel $webhook[url][high_mortal];#var chatCategory high_mortal;
	};

	#if {$tmpCommParty} {
		#var discordChannel $webhook[url][party];#var chatCategory party;
	};

	#if {$tmpCommClan} {
		#var discordChannel $webhook[url][clan];#var chatCategory clan;
	};

	#if {$tmpCommGuild} {
		#var discordChannel $webhook[url][guild];#var chatCategory guild;
	};
};

#ALIAS {.mipProcessCAA} {
	#REGEX {%1} {{(.*)\~(.*)\~(.*)\~(.*)}} {
		#var lastData $mip[comm][cdata];
		#var {mip[comm][command]}	{&2};
		#var {mip[comm][line]}		{&3};
		#var {mip[comm][source]}	{&4};
		#var {mip[comm][data]}		{@ansiStrip{&5}};

		#format {timestamp} {%t} {<108>[<268>%H<108>:<268>%M<108>]<088> };
		#format {datestamp} {%t} {%Y-%m-%d.log};

		#NOP Ansify lines;
		#var {commcol} {<178>};

		#NOP -- Default discord channel is general.  Ansi and discord channel it is directed to;
		#NOP -- are managed via the .handleCommLine alias;

		#var discordChannel $webhook[url][general];
		.handleCommLine {$mip[comm][line]};
		
		#var {mip[comm][cdata]} {$mip[comm][data]};
		#replace {mip[comm][cdata]} {:} {:<099>};
		#replace {mip[comm][cdata]} {]} {]<099>};
		
		#var {mip[comm][cdata]} {${commcol}${mip[comm][cdata]}<099>};

		#NOP if it's the same as the last line, do nothing to prevent spam;
		#if {"$mip[comm][cdata]" != "$lastData"} {
			#line log {logs/$sysUser/$datestamp} {$timestamp\};
			#line log {logs/$sysUser/$datestamp} {$mip[comm][cdata]};
			
			update_chat {$mip[comm][cdata]};
		};
	}
};

#NOP ***** 2 Way Communication (Tell/Emote) *****;

#NOP -- This toggle will allow you to log just tells or emotes + tells;
#NOP -- Flag specifically if it's a tell using action;
#NOP -- If it matches the MIP sender, we'll log it so mobs/echo's don't get logged;
#action {^%w tells you: %*} {#var chat[act_tell][from] %1;#delay 10 {#unvar chat[act_tell][from]}} {2};
#action {^%w tells you (%*): %*} {#var chat[act_tell][from] %1;#var chat[group] %2;#delay 10 {#unvar chat[act_tell][from];#unvar chat[group]}} {2};
#action {^You tell %w:} {#var chat[act_tell][from] $userCap};

#NOP -- Linktells;
#action {^%w LTs \(%*\)} {#var chat[act_tell][from] %1;#delay 10 {#unvar chat[act_tell][from]}} {2};

#NOP -- Jedi think;
#action {^%w thinks . o O \(  %*  \)} {
	#var mip[comm][twoway] {from};
	#var chat[act_tell][from] %1;
	#var mip[comm][source] %1;
	#var mip[comm][data] %2;
	update_chat <178>$mip[comm][source]<088>: $mip[comm][data];
	#delay 10 {#unvar chat[act_tell][from]}
} {2};

#NOP -- Breed projection;
#action {^You project to %w: %*} {
	#var mip[comm][twoway] {to};
	#var mip[comm][data] {%2};
	update_chat <178>To %1<088>: $mip[comm][data];
} {2};

#action {^%w projects to you: %*} {
	#var mip[comm][twoway] {from};
	#var chat[act_tell][from] %1;
	#var mip[comm][source] %1;
	#var mip[comm][data] %2;
	update_chat <178>$mip[comm][source]<088>: $mip[comm][data];
	#delay 10 {#unvar chat[act_tell][from]}
} {2};


#alias {chatlog %1} {
	#if {"%1" == "emotes"} {
		#if {"$chat[log][emotes]" === ""} {
			#var chat[log][emotes] 1;
			#echo {<cfa> ========== CHATLOG IS NOW LOGGING EMOTES ========== };
		} {
			#if $chat[log][emotes] {
				#var chat[log][emotes] 0;
				#echo {<fda> ========== CHATLOG WILL NOT LOG EMOTES ========== };
			} {
				#var chat[log][emotes] 1;
				#echo {<cfa> ========== CHATLOG IS NOW LOGGING EMOTES ========== };
			}
		};
	};
};

#ALIAS {.mipProcessBABgag} {
	#var mipgag 0;
	#var tempString %0;

	#NOP Duplicate 'from' soul;
	#REGEX {$tempString} {~you~} {#var mipgag 1};


	#NOP Add cases for tells/emotes to gag from monitor, such as mob emotes;

	#NOP Player specific gags;
	#NOP Byron crying OW;
	#REGEX {$tempString} {~Byron~cries 'OW!!'} {#var mipgag 1};
	#REGEX {$tempString} {~Owie.~That hurt!} {#var mipgag 1};
	#REGEX {$tempString} {~%*~pokes %* in the ribs} {#var mipgag 1};

	#NOP Guilds and Areass;
	#NOP Bards;
	#REGEX {$tempString} {~%*~cracks %* knuckles and gets ready to play for %*.} {#var mipgag 1};
	#REGEX {$tempString} {~%*ceases %* performance.} {#var mipgag 1};
	#REGEX {$tempString} {~%*takes a deep breath.} {#var mipgag 1};
	#REGEX {$tempString} {~%*takes a breath.} {#var mipgag 1};
	#REGEX {$tempString} {~%*pauses for a moment...} {#var mipgag 1};
	#REGEX {$tempString} {~%*ceases %* performance.} {#var mipgag 1};
	#REGEX {$tempString} {~%*~finishes %* performance with a bow.} {#var mipgag 1};
	#REGEX {$tempString} {~%*~takes a deep breath and prepares to perform a song for you.%s} {#var mipgag 1};
	#REGEX {$tempString} {~Great~cheer fills you, it's almost overwhelming!} {#var mipgag 1};
	#REGEX {$tempString} {~%*smiles happily.} {#var mipgag 1};
	#REGEX {$tempString} {~takes a deep breath and prepares to perform a song for %*.} {#var mipgag 1};
	#REGEX {$tempString} {~%*sings soulfully} {#var mipgag 1};

	#NOP Mages;
	#REGEX {$tempString} {~%*~makes slicing motions across %* throat towards %*.} {#var mmipgag 1};

	#NOP Bladesingers;
	#REGEX {$tempString} {~Corath~} {#var mipgag 1};
	#REGEX {$tempString} {~Amarul~} {#var mipgag 1};

	#NOP Breed;
	#REGEX {$tempString} {looks visibly weaker!} {#var mipgag 1};
	#REGEX {$tempString} {looks more vulnerable!} {#var mipgag 1};

	#NOP Changelings;
	#REGEX {$tempString} {~The~%*'s wounds close rapidly.} {#var mipgag 1};
	#REGEX {$tempString} {~The~%* performs a rather incomprehensible action on the corpse.} {#var mipgag 1};
	#REGEX {$tempString} {~The~small wolf sighs.} {#var mipgag 1};
	#REGEX {$tempString} {~Before your very eyes, the %* morphs into %*} {#var mipgag 1};

	#NOP Cove of the Three (Lost Soul);
	#REGEX {$tempString} {~~You try to clasp onto the diamond spectacle, but your hands fall right through!} {#var mipgag 1};
	#REGEX {$tempString} {~~Bursts of %* colored energy shoot off from the spectacle.} {#var mipgag 1};
	#REGEX {$tempString} {~~The diamond-spectacle spins and turns on an unseen axis.} {#var mipgag 1};
	#REGEX {$tempString} {~~The diamond-shaped spectacle changes color.} {#var mipgag 1};

	#NOP Carina's Observatory;
	#REGEX {$tempString} {~~Carina looks up at you as if to say something, but shrugs it off.} {#var mipgag 1};

	#NOP Duke Nukem;
	#REGEX {$tempString} {~~As you land upon the rooftop, you see your ship crash into a building in the} {#var mipgag 1};
	#REGEX {$tempString} {~~You break the fan, revealing an exit!} {#var mipgag 1};
	#REGEX {$tempString} {~~You see the assault trooper and taunt him, WHO'S YOUR DADDY!!??} {#var mipgag 1};
	#REGEX {$tempString} {~~The room shakes.......And a piece of the wall is blown away!} {#var mipgag 1};

	#NOP Dundee;
	#REGEX {$tempString} {~A~shiver runs through you as you successfully fight off an infection.} {#var mipgag 1};
	#REGEX {$tempString} {~Your~head throbs briefly as you successfully fight off an infection.} {#var mipgag 1};
	#REGEX {$tempString} {~Your~temperature spikes as you successfully fight off an infection.} {#var mipgag 1};
	#REGEX {$tempString} {~Your~palms begin to sweat as you successfully fight off an infection.} {#var mipgag 1};
	#REGEX {$tempString} {~Your~neck aches slightly as you successfully fight off an infection.} {#var mipgag 1};

	#NOP Hell Cows;
	#REGEX {$tempString} {~A~cow falls, but the herd continues on!} {#var mipgag 1};
	#REGEX {$tempString} {~The~lonesome cow topples to the ground, the herd finally slain.} {#var mipgag 1};

	#NOP Knights;
	#REGEX {$tempString} {~Bela~} {#var mipgag 1};

	#NOP Necropolis;
	#REGEX {$tempString} {~%*~winces from the pain.} {#var mipgag 1};
	#REGEX {$tempString} {~%*~pukes all over %* new shoes.} {#var mipgag 1};
	#REGEX {$tempString} {~%*~coughs noisily.} {#var mipgag 1};

	#NOP Necromancer;
	#REGEX {$tempString} {~The~spirit of the beast leaves your body, slightly weakening you.} {#var mipgag 1};
	#REGEX {$tempString} {~%*~%* appears slightly drained.} {#var mipgag 1};
	#REGEX {$tempString} {~%*~lumbering creature staggers for a moment.} {#var mipgag 1};
	#REGEX {$tempString} {~%*~nightmarish creature moans horribly.} {#var mipgag 1};
	#REGEX {$tempString} {~%*~screams loudly!!!} {#var mipgag 1};
	#REGEX {$tempString} {~%*~stumbles for a moment as his power fades.} {#var mipgag 1};
	#REGEX {$tempString} {~%*~%* shivers from the cold...} {#var mipgag 1};
	

	#NOP Party Divvy;
	#REGEX {$tempString} {[PARTY] GOLD divvy called by } {#var mipgag 1};
	#REGEX {$tempString} {[PARTY] All gold divvied, total: } {#var mipgag 1};

	#NOP Sii;
	#REGEX {$tempString} {~Your~malicious attacks fade} {#var mipgag 1};
	#REGEX {$tempString} {~The~corpse explodes as a small vicious lizard-like creature bursts forth!} {#var mipgag 1};

	#NOP Tomb of King Alaren;
	#REGEX {$tempString} {~With~a mighty heave you shoulder charge into the eastern wall.} {#var mipgag 1};
	#REGEX {$tempString} {~~With a slow rumble the wall finally crumbles, filling the room in a cloud of} {#var mipgag 1};
	#REGEX {$tempString} {~His~service to his King complete, the guard clatters to the floor, the dark magic} {#var mipgag 1};
	#REGEX {$tempString} {~The~skeletal royal guard steps in front of you barring your progress.} {#var mipgag 1};
	#REGEX {$tempString} {~Harakir~slumps to the floor, defeated, perhaps now his soul will find} {#var mipgag 1};
	#REGEX {$tempString} {~With~a few swings of your } {#var mipgag 1};
	#REGEX {$tempString} {~With~a mighty heave you push the [stone|golden] lid sliding it back from the coffin} {#var mipgag 1};
	#REGEX {$tempString} {~Turning~to leave you hear Mircarla's sultry voice calling you back} {#var mipgag 1};
	#REGEX {$tempString} {~Caught~unaware by her turn of pace as you attack, you} {#var mipgag 1};
	#REGEX {$tempString} {~Before~your very eyes you stare in amazement as Mircarla} {#var mipgag 1};
	#REGEX {$tempString} {~Her~meal completed, she clambers off you licking her now ruby red lips} {#var mipgag 1};
	#REGEX {$tempString} {~Mircarla~sighs, the last of her energy expended as she slumps to the floor} {#var mipgag 1};
	#REGEX {$tempString} {~Sumaren~crumples to the ground, destroyed, perhaps at last his soul will find} {#var mipgag 1};
	#REGEX {$tempString} {~Someone~has already pushed the lid open, there's no need to push it again.} {#var mipgag 1};
	#REGEX {$tempString} {~Straining~with all your might you give the ring a mighty heave, at first} {#var mipgag 1};
	#REGEX {$tempString} {~Reaching~out, you give the gates a firm push. With an echoing screech the} {#var mipgag 1};
	#REGEX {$tempString} {~Alaren~begins to slowly lose cohesion, glowing ever brighter until, suddenly} {#var mipgag 1};
	#REGEX {$tempString} {~The~skeletal guard steps in front of you barring your progress.} {#var mipgag 1};

	#NOP Wrapping with no corpse in room;
	#REGEX {$tempString} {~%*~wraps %* arms around %*.} {#var mipgag 1};

	#NOP Garden Hoe;
    #REGEX {$tempString} {~%w~screams, "Take that hoe!"} {#var mipgag 1};
    #REGEX {$tempString} {~The~rusty looking hoe that %w is wielding slips horribly from %w grip} {#var mipgag 1};

	#NOP Zelligar's Headband;
	#REGEX {$tempString} { stumbles in confusion as the headband hypnotizes } {#var mipgag 1};

	#IF {$mipgag == 0} {.mipProcessBAB %0;};
};

#ALIAS {.mipProcessBAB} {
	#REGEX {%1} {{(.*)\~(.*)\~(.*)}} {
		#IF {"&3" != "0"} {
			#var lastData $mip[comm][data];
			#var discordChannel $webhook[url][tells];
			#var chatCategory tells;
			#var mip[comm][data]	{@ansiStrip{&4}};
			#var mip[comm][source]	{&3};
			#var mip[comm][line]	{Tell};

			
			#NOP Revert ^^ back to ~;
			#REPLACE {mip[comm][data]} {\^\^} {~};
			
			#var mip[comm][command]	{tell $mip[comm][source]};
			#format {timestamp} {%t} {<108>[<268>%H<108>:<268>%M<108>]<088> };
			#format {datestamp} {%t} {%Y-%m-%d.log};
			#format {timestamp_save} {%t} {[%H:%M] };
			#if {"$mip[comm][data]" != "$lastData"} {
				#IF {"&2" == "x"} {
					#NOP Message to another player;
					#var mip[comm][twoway] {to};
					#line log {logs/$sysUser/$datestamp} {$timestamp_save\};
					#line log {logs/$sysUser/$datestamp} {<ead>To &3<088>: &4};
					update_chat <178>To $mip[comm][source]<088>: $mip[comm][data];
				} {
					#NOP Message from another player;
					#NOP -- If the MIP data source matches the tell source registered by the action, we log the chat;
					#NOP -- Make sure we have a source, otherwise it's likely an action/emote triggering the MIP;
					#if {"$mip[comm][source]" != ""} {
						#if {$chat[log][emotes]} {
							#var mip[comm][twoway] {from};
							#line log {logs/$sysUser/$datestamp} {$timestamp_save\};
							#line log {logs/$sysUser/$datestamp} {<ead>&3<088>: &4};
							#if {"$chat[group]" === ""} {
								update_chat <178>$mip[comm][source]<088>: $mip[comm][data];
							} {
								update_chat <178>$mip[comm][source] + $chat[group]<088>: $mip[comm][data];
							};
							#bell;
						} {
							#if {"$chat[act_tell][from]" == "$mip[comm][source]"} {
								#var mip[comm][twoway] {from};
								#line log {logs/$sysUser/$datestamp} {$timestamp_save\};
								#line log {logs/$sysUser/$datestamp} {<ead>&3<088>: &4};
								#if {"$chat[group]" === ""} {
									update_chat <178>$mip[comm][source]<088>: $mip[comm][data];
								} {
									update_chat <178>$mip[comm][source] + $chat[group]<088>: $mip[comm][data];
								};
								#bell;
							};
						}
						
					};
				};
			};
		};
	};
};

#var chat[max] 30;
#var chat[offset] 0;
#var chat[page] 1;
#var chat[scroll] page;


#function formatHeader {
	#var result <088><dab>[<fcc> %0 <dab>]<088>;
	#return $result;
};


#alias .messagesMarkRead {
	#var chat[unread][general] 0;
	#var chat[unread][tells] 0;
	#var chat[unread][clan] 0;
	#var chat[unread][guild] 0;
	#var chat[unread][high_mortal] 0;
	#var chat[unread][party] 0;
};

.messagesMarkRead;

#alias updateChatCategory {
	#switch {"$chatCategory"} {
		#case {"party"} {#var partyString @formatHeader{PARTY}};
		#case {"tells"} {#var tellString @formatHeader{TELLS}};
		#case {"clan"} {#var clanString @formatHeader{CLAN}};
		#case {"guild"} {#var guildString @formatHeader{GUILD}};
		#case {"high_mortal"} {#var hmString @formatHeader{HM}};
	};
	#delay {clearCategory} {#var chatCategory {};draw_chat} {4};
};

#alias .messages {
	#NOP -- Show the last 5 messages received in each category;
	#if {$chat[unread][clan] > 0} {
		#showme <efc>-----    CLAN    -----;
	};

	
	.messagesMarkRead;
};

#alias {clearChatHeader} {

	#NOP    Moving color settings into themes.tin;
	#NOP	#var partyString <ffc>PARTY<088>;
	#NOP	#var tellString <fac>TELLS<088>;
	#NOP	#var clanString <ffe>CLAN<088>;
	#NOP	#var guildString <cfe>GUILD<088>;
	#NOP	#var hmString <faf>HM<088>;

	#NOP Colors are set in common/themes.tin;
	#var partyString ${theme[chatHeader][party]}PARTY<088>;
	#var tellString ${theme[chatHeader][tells]}TELLS<088>;
	#var clanString ${theme[chatHeader][clan]}CLAN<088>;
	#var guildString ${theme[chatHeader][guild]}GUILD<088>;
	#var hmString ${theme[chatHeader][hm]}HM<088>;
};

#ALIAS {draw_chat} {
	#math chat[start]	{$chat[rows]};
	#math chat[end]		{$chat[offset] + 1};

	filterSpam;
	updateChatCategory;
	#if {"$draw[chat][active]" == "on"} {
		#line sub var #line sub esc #draw $theme[chatbox] left right side 2 1 $chat[height]-1 $chat[right] $chat[general][-$chat[start]..-$chat[end]];
		#draw $theme[chatbox] calign jeweled line 1 1 1 $map[left]  {    $tellString    $partyString    $clanString    $guildString    $hmString    };
	};
};


#ALIAS {update_chat} {
	#format {timestamp} {%t} {<108>[<268>%H<108>:<268>%M<108>]<088> };
	#if {&chat[general][] >= $chat[max]} {
		#list chat[general] del 1;
	};
	#NOP remove esc chars;
	#var chat[text] %0;
	#replace {chat[text]} {\\x7B} {\uFF5B};
	#replace {chat[text]} {\\x7D} {\uFF5D};
	
	#list chat[general] ins -1 {${timestamp}${chat[text]}};
	#var discordText ${mip[comm][source]}: ${mip[comm][data]};
	#if {$discordPost && !$mipgag} {postDiscord ${discordText}};
	#if {"$chatCategory" != "general"} {postChatCategory};
	draw_chat;
};

#ALIAS {chatup} {
	#if {"$chat[scroll]" == "page"} {
		#if {$chat[rows]*{$chat[page]+1} <= $chat[max] &&
		     $chat[rows]*{$chat[page]+1} <= &chat[general][]} {
			#math chat[page] {$chat[page] + 1};
			#math chat[offset] {$chat[page] * $chat[rows] - $chat[rows]};
			draw_chat;
		};
	}; #elseif {"$chat[scroll]" == "line"} {
		#if {$chat[offset] <= $chat[max] &&
		     $chat[offset] <= &chat[general][]} {
			#math chat[offset] {$chat[offset] + 1};
			draw_chat;
		};
	};
};

#ALIAS {chatdown} {
	#if {"$chat[scroll]" == "page"} {
		#if {$chat[page] > 1} {
			#math chat[page] {$chat[page] - 1};
			#math chat[offset] {$chat[page] * $chat[rows] - $chat[rows]};
			draw_chat;
		}
	}; #elseif {"$chat[scroll]" == "line"} {
		#if {$chat[offset] > 0} {
			#math chat[offset] {$chat[offset] - 1};
			draw_chat;
		}
	}
};
#ALIAS {chatend} {
	#var chat[page] 1;
	#var chat[offset] 0;
	draw_chat
};

#class {mipchatlog} {close}
